<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文稿卫士 - 文档错别字查错与排版优化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="loadToolConfig.js"></script>
        <script src="document_guard_fix.js"></script>
        <script src="document_guard_enhanced.js"></script>
        <script src="document_guard_highlight_fix.js"></script>
        <script src="document_guard_scroll_fix.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#4f46e5',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .bg-gradient-blue {
                background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
    <!-- 顶部导航栏 - 紧凑版 -->
    <header class="h-12 bg-white border-b border-gray-200 flex items-center px-4 sticky top-0 z-30 shadow-sm">
        <div class="flex items-center space-x-2">
            <a href="http://localhost:8080/" class="text-gray-600 hover:text-primary">
                <i class="fa fa-arrow-left text-lg"></i>
            </a>
            <h1 class="text-lg font-semibold text-gray-800">文稿卫士</h1>
        </div>
        <div class="flex-1 mx-4 flex items-center justify-center">
            <div class="text-xs text-gray-500 hidden md:block">
                <span>首页</span> &gt; <span>文稿智匠</span> &gt; <span class="text-primary">文稿卫士</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button class="text-gray-500 hover:text-primary relative">
                <i class="fa fa-bell text-lg"></i>
                <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fa fa-shield-alt"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- 主要功能区 -->
        <div class="flex-1 flex overflow-hidden">
            <!-- 左侧面板：文档编辑区域 -->
            <div class="w-full md:w-1/2 bg-white border-r border-gray-200 overflow-hidden flex flex-col">
                <!-- 顶部工具栏 -->
                <div class="bg-white border-b border-gray-200 p-3 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <button id="upload-file-btn" class="px-3 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:bg-primary/90 transition-colors flex items-center shadow-sm">
                            <i class="fa fa-upload mr-1.5"></i>上传文件
                        </button>
                        <button id="clear-content-btn" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-200 transition-colors flex items-center">
                            <i class="fa fa-trash-alt mr-1.5"></i>清空内容
                        </button>
                        <input type="file" class="hidden" id="file-input" accept=".txt,.doc,.docx,.pdf">
                    </div>
                    <div id="file-info" class="text-sm text-gray-500 hidden flex items-center">
                        <i class="fa fa-file-alt mr-1"></i>
                        <span id="file-name"></span>
                        <button id="remove-file" class="ml-2 text-gray-400 hover:text-red-500 transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 整个区域作为文本编辑、展示框 -->
                <div id="document-content" class="flex-1 p-4 overflow-y-auto w-full bg-white focus:outline-none transition-all" contenteditable="true" style="min-height: calc(100vh - 150px);">
                    <p class="text-gray-400">在此处输入或粘贴文本内容，或点击上方上传按钮导入文件...</p>
                </div>
            </div>
            
            <!-- 右侧面板：结果展示 -->
            <div class="w-full md:w-1/2 bg-white flex flex-col overflow-hidden">
                <!-- 结果头部 -->
                <div class="bg-white border-b border-gray-200 p-4 flex flex-wrap items-center justify-between">
                    <div class="flex items-center space-x-4 mb-2 md:mb-0">
                        <button class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors shadow-sm">
                            <i class="fa fa-magic mr-1"></i>一键优化
                        </button>
                        <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors">
                            <i class="fa fa-download mr-1"></i>导出文档
                        </button>
                    </div>
                    <div class="flex items-center justify-end">
                        <button class="p-2 rounded-full hover:bg-gray-100 text-gray-600 transition-colors">
                            <i class="fa fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 错误列表 -->
                <div class="flex-1 overflow-y-auto p-3" style="min-height: calc(100vh - 150px);">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fa fa-search mr-2 text-primary"></i>错误详情 (<span id="error-count">0</span>)
                    </h3>
                    
                    <!-- 错误类型切换 -->
                    <div class="flex overflow-x-auto scrollbar-hide mb-4 space-x-2 pb-2">
                        <button id="all-errors-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm whitespace-nowrap shadow-sm">
                            全部错误 (0)
                        </button>
                        <button id="typo-errors-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">
                            错别字 (0)
                        </button>
                        <button id="grammar-errors-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">
                            语法错误 (0)
                        </button>

                        <button id="suggestion-btn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm whitespace-nowrap hover:bg-gray-50 transition-colors">
                            优化建议 (0)
                        </button>
                    </div>
                    
                    <!-- 错误列表项 -->
                        <div class="space-y-2">
                        <!-- 错误检测结果将动态生成在这里 -->
                        <div id="error-results" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fa fa-file-text-o text-4xl mb-2 text-gray-300"></i>
                                <p>上传文件后将显示错误检测结果</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 px-6 text-center text-sm text-gray-500">
        <p>© 2025 光明数字员工系统 - 文稿卫士工具</p>
    </footer>

    <!-- JavaScript -->
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取左右两侧的滚动容器
            const leftContent = document.getElementById('document-content');
            const rightContent = document.querySelector('.flex-1.overflow-y-auto.p-4');
            
            // 确保左右两侧内容同步显示
            if (leftContent && rightContent) {
                // 当右侧滚动时，确保左侧内容不为空
                rightContent.addEventListener('scroll', function() {
                    if (leftContent.textContent.trim() === '' && leftContent.innerHTML.includes('text-gray-400')) {
                        // 如果左侧为空，设置默认提示文本
                        leftContent.innerHTML = `<p class="text-gray-400">在此处输入或粘贴文本内容，或点击上方上传按钮导入文件...</p>`;
                    }
                });
            }
            
            // 获取DOM元素
            // 获取DOM元素
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');
            const removeFileBtn = document.getElementById('remove-file');
            const documentContent = document.getElementById('document-content');
            const uploadFileBtn = document.getElementById('upload-file-btn');
            const fileInfo = document.getElementById('file-info');
            const clearContentBtn = document.getElementById('clear-content-btn');
            
            // 点击上传按钮触发文件选择
            uploadFileBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件选择后处理
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelection(this.files[0]);
                }
            });
            
            // 移除文件
            removeFileBtn.addEventListener('click', function() {
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                documentContent.innerHTML = `<p class="text-gray-400">在此处输入或粘贴文本内容，或点击上方上传按钮导入文件...</p>`;
            });
            
            // 文档内容区域获得焦点时清除提示文本
            documentContent.addEventListener('focus', function() {
                if (this.innerHTML.includes('text-gray-400')) {
                    this.innerHTML = '';
                }
                this.style.background = '#fafafa';
                this.style.padding = '20px';
                this.style.borderRadius = '8px';
            });
            
            // 文档内容区域失去焦点时添加提示文本（如果内容为空）
            documentContent.addEventListener('blur', function() {
                if (this.textContent.trim() === '') {
                    this.innerHTML = `<p class="text-gray-400">在此处输入或粘贴文本内容，或点击上方上传按钮导入文件...</p>`;
                    this.style.background = 'white';
                    this.style.padding = '24px';
                    this.style.borderRadius = '0';
                }
            });
            
            // 简化的错误卡片点击事件处理
            function setupErrorCardInteractions() {
                // 移除所有现有的错误卡片事件监听器
                const oldCards = document.querySelectorAll('.error-content-card');
                oldCards.forEach(card => {
                    const newCard = card.cloneNode(true);
                    card.parentNode.replaceChild(newCard, card);
                });
                
                // 使用事件委托方式处理错误卡片点击
                const errorResultsContainer = document.getElementById('error-results');
                if (errorResultsContainer) {
                    // 先移除现有的点击事件，避免重复绑定
                    const newContainer = errorResultsContainer.cloneNode(true);
                    errorResultsContainer.parentNode.replaceChild(newContainer, errorResultsContainer);
                    
                    // 重新添加事件委托
                    newContainer.addEventListener('click', function(event) {
                        console.log('事件委托捕获到点击:', event.target);
                        
                        // 查找最近的错误内容卡片
                        const errorCard = event.target.closest('.error-content-card');
                        if (errorCard) {
                            console.log('找到错误卡片:', errorCard);
                            
                            // 获取错误文本和原始文本
                            let errorText = errorCard.getAttribute('data-error-text');
                            let originalText = errorCard.getAttribute('data-original-text') || errorText;
                            
                            console.log('卡片数据 - errorText:', errorText);
                            console.log('卡片数据 - originalText:', originalText);
                            
                            // 如果没有数据属性，使用textContent
                            if (!errorText) {
                                errorText = errorCard.textContent.trim();
                                console.log('使用textContent作为errorText:', errorText);
                            }
                            
                            if (!originalText) {
                                originalText = errorText;
                                console.log('使用errorText作为originalText:', originalText);
                            }
                            
                            // 移除之前的高亮
                            console.log('移除之前的高亮元素');
                            document.querySelectorAll('.highlighted-text').forEach(el => {
                                const parent = el.parentNode;
                                if (parent) {
                                    parent.replaceChild(document.createTextNode(el.textContent), el);
                                }
                            });
                            
                            // 执行高亮
                            console.log('执行高亮操作');
                            highlightTextInDocument(originalText, errorText);
                        }
                    });
                }
                
                console.log('错误卡片交互设置完成');
            }
            
            // 在文档内容中高亮显示指定文本
            function highlightTextInDocument(originalText, contextText) {
                addDebugLog('尝试高亮文本: "' + (originalText || '空') + '"');
                addDebugLog('上下文文本: "' + (contextText || '空') + '"');
                
                // 获取文档内容元素
                const documentContent = document.getElementById('document-content');
                if (!documentContent) {
                    addDebugLog('❌ 错误: 未找到document-content元素！');
                    return;
                }
                
                // 选择使用的文本
                const textToHighlight = originalText || contextText;
                if (!textToHighlight) {
                    addDebugLog('❌ 错误: 没有可高亮的文本！');
                    return;
                }
                
                addDebugLog('文档内容长度: ' + documentContent.textContent.length + ' 字符');
                
                // 简单直接的高亮方法：选择文档中的第一个匹配项
                const textNodes = [];
                function collectTextNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        textNodes.push(node);
                    } else {
                        for (let i = 0; i < node.childNodes.length; i++) {
                            collectTextNodes(node.childNodes[i]);
                        }
                    }
                }
                collectTextNodes(documentContent);
                
                addDebugLog('找到文本节点数量: ' + textNodes.length);
                
                // 尝试找到匹配的文本节点
                let found = false;
                
                addDebugLog('开始在文档中搜索文本: "' + textToHighlight + '"');
                
                for (let i = 0; i < textNodes.length; i++) {
                    const textNode = textNodes[i];
                    const textNodeContent = textNode.textContent;
                    const index = textNodeContent.indexOf(textToHighlight);
                    
                    // 记录前5个文本节点的内容片段，帮助调试
                    if (i < 5) {
                        const snippet = textNodeContent.length > 50 ? textNodeContent.substring(0, 50) + '...' : textNodeContent;
                        addDebugLog(`文本节点 ${i}: "${snippet}"`);
                    }
                    
                    if (index !== -1) {
                        addDebugLog('✅ 找到匹配文本节点:', i);
                        addDebugLog('匹配位置: 第' + index + '个字符');
                        addDebugLog('匹配上下文: "' + textNodeContent.substring(Math.max(0, index-20), Math.min(textNodeContent.length, index+textToHighlight.length+20)).replace(/\n/g, ' ') + '"');
                        
                        try {
                            // 创建Range对象
                            const range = document.createRange();
                            const selection = window.getSelection();
                            
                            // 设置Range范围
                            range.setStart(textNode, index);
                            range.setEnd(textNode, index + textToHighlight.length);
                            
                            // 清除当前选择
                            selection.removeAllRanges();
                            
                            // 添加新的Range到选择
                            selection.addRange(range);
                            
                            // 滚动到选中的文本
                            range.startContainer.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // 创建高亮元素
                            const highlight = document.createElement('span');
                            highlight.className = 'highlighted-text bg-yellow-200';
                            
                            // 环绕Range内容
                            try {
                                range.surroundContents(highlight);
                                addDebugLog('✅ 成功使用surroundContents方法高亮文本');
                            } catch (e) {
                                addDebugLog('⚠️ 环绕内容失败，使用替代方法:', e.message);
                                // 如果内容跨多个元素，使用另一种方式
                                const fragment = range.extractContents();
                                highlight.appendChild(fragment);
                                range.insertNode(highlight);
                                addDebugLog('✅ 成功使用替代方法高亮文本');
                            }
                            
                            found = true;
                            break;
                        } catch (e) {
                            addDebugLog('❌ 高亮过程中出现错误:', e.message);
                        }
                    }
                }
                
                if (!found) {
                    addDebugLog('⚠️ 未找到匹配的文本 "' + textToHighlight + '"，使用演示高亮');
                    // 演示高亮：高亮文档的前几个字符
                    if (textNodes.length > 0) {
                        const firstNode = textNodes[0];
                        const demoRange = document.createRange();
                        const demoSelection = window.getSelection();
                        
                        const demoLength = Math.min(20, firstNode.textContent.length);
                        demoRange.setStart(firstNode, 0);
                        demoRange.setEnd(firstNode, demoLength);
                        
                        demoSelection.removeAllRanges();
                        demoSelection.addRange(demoRange);
                        
                        const demoHighlight = document.createElement('span');
                        demoHighlight.className = 'highlighted-text bg-yellow-200';
                        
                        try {
                            demoRange.surroundContents(demoHighlight);
                            addDebugLog('✅ 演示高亮成功应用于文档开头');
                        } catch (e) {
                            addDebugLog('❌ 演示高亮失败:', e.message);
                        }
                        
                        firstNode.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        addDebugLog('❌ 文档中没有可高亮的文本节点');
                    }
                }
                
                addDebugLog('高亮操作完成');
            }
                
                // 绑定采纳建议按钮事件的单独函数
                function setupAdoptButtons() {
                    // 先移除所有现有的采纳按钮事件监听器
                    const oldButtons = document.querySelectorAll('.adopt-suggestion-btn');
                    oldButtons.forEach(btn => {
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);
                    });
                    
                    // 重新绑定事件
                    document.querySelectorAll('.adopt-suggestion-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                             
                            // 获取原始文本和纠正文本
                            // 注意：需要进行HTML解码，因为在创建按钮时使用了escapeHtml
                            const encodedOriginalText = this.getAttribute('data-original');
                            const encodedCorrectedText = this.getAttribute('data-corrected');
                            
                            // 添加HTML解码函数
                            function htmlDecode(str) {
                                if (!str) return '';
                                const doc = new DOMParser().parseFromString(str, 'text/html');
                                return doc.documentElement.textContent;
                            }
                            
                            // 解码HTML实体
                            const originalText = htmlDecode(encodedOriginalText);
                            const correctedText = htmlDecode(encodedCorrectedText);
                            
                            // 检查当前是否已采纳状态
                            const isAdopted = this.getAttribute('data-adopted') === 'true';
                             
                            // 切换文本 - 如果已采纳，则回退到原始文本
                            const sourceText = isAdopted ? correctedText : originalText;
                            const targetText = isAdopted ? originalText : correctedText;
                              
                            console.log('--- 文本替换调试信息 ---');
                            console.log('原始编码文本:', encodedOriginalText);
                            console.log('纠正编码文本:', encodedCorrectedText);
                            console.log('解码后原始文本:', originalText);
                            console.log('解码后纠正文本:', correctedText);
                            console.log('源文本:', sourceText);
                            console.log('目标文本:', targetText);
                            console.log('是否已采纳:', isAdopted);
                            addDebugLog('--- 文本替换调试信息 ---');
                            addDebugLog('原始编码文本:', encodedOriginalText);
                            addDebugLog('纠正编码文本:', encodedCorrectedText);
                            addDebugLog('解码后原始文本:', originalText);
                            addDebugLog('解码后纠正文本:', correctedText);
                            addDebugLog('源文本:', sourceText);
                            addDebugLog('目标文本:', targetText);
                            addDebugLog('是否已采纳:', isAdopted);
                            
                            if (sourceText && targetText) {
                                try {
                                    // 获取文档内容区域
                                    const documentContent = document.getElementById('document-content');
                                    if (!documentContent) {
                                        console.error('未找到document-content元素');
                                        showNotification('操作时出错，请重试', 'error');
                                        return;
                                    }
                                    
                                    // 临时设置contentEditable为false以确保替换可靠
                                    const wasEditable = documentContent.contentEditable;
                                    documentContent.contentEditable = 'false';
                                    
                                    // 递归查找并替换文本节点中的内容
                                    let replaced = false;
                                    
                                    // 递归处理所有子节点
                                    function findAndReplaceInTextNodes(node) {
                                        if (node.nodeType === Node.TEXT_NODE) {
                                            // 处理文本节点
                                            const text = node.textContent;
                                            // 使用indexOf进行查找，更加灵活
                                            const index = text.indexOf(sourceText);
                                            if (index !== -1) {
                                                // 创建新的文本节点来替换
                                                const newText = text.replace(sourceText, targetText);
                                                const newTextNode = document.createTextNode(newText);
                                                node.parentNode.replaceChild(newTextNode, node);
                                                replaced = true;
                                                console.log('在文本节点中找到并替换了文本:', sourceText, '->', targetText);
                                                addDebugLog('在文本节点中找到并替换了文本:', sourceText, '->', targetText);
                                                return true;
                                            }
                                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                                            // 跳过脚本和样式元素
                                            if (node.tagName === 'SCRIPT' || node.tagName === 'STYLE') {
                                                return false;
                                            }
                                            
                                            // 递归处理所有子节点
                                            for (let i = 0; i < node.childNodes.length && !replaced; i++) {
                                                if (findAndReplaceInTextNodes(node.childNodes[i])) {
                                                    return true;
                                                }
                                            }
                                        }
                                        return false;
                                    }
                                    
                                    // 开始递归查找并替换
                                    replaced = findAndReplaceInTextNodes(documentContent);
                                    console.log('递归查找替换结果:', replaced);
                                    addDebugLog('递归查找替换结果:', replaced);
                                    
                                    // 如果第一次查找失败，尝试使用更宽松的匹配方式
                                    if (!replaced) {
                                        console.log('尝试使用更宽松的匹配方式');
                                        addDebugLog('尝试使用更宽松的匹配方式');
                                        
                                        // 显示当前文档HTML内容片段以帮助调试
                                        const docContentPreview = documentContent.textContent.substring(0, 200) + '...';
                                        console.log('文档内容预览:', docContentPreview);
                                        addDebugLog('文档内容预览:', docContentPreview);
                                        
                                        // 尝试在整个文档HTML中进行替换（作为备选方案）
                                        const docHTML = documentContent.innerHTML;
                                        console.log('文档HTML包含源文本:', docHTML.includes(sourceText));
                                        addDebugLog('文档HTML包含源文本:', docHTML.includes(sourceText));
                                        
                                        if (docHTML.includes(sourceText)) {
                                            const newHTML = docHTML.replace(sourceText, targetText);
                                            documentContent.innerHTML = newHTML;
                                            replaced = true;
                                            console.log('通过HTML替换找到了并替换了文本:', sourceText, '->', targetText);
                                            addDebugLog('通过HTML替换找到了并替换了文本:', sourceText, '->', targetText);
                                        }
                                    }
                                    
                                    // 恢复contentEditable状态
                                    documentContent.contentEditable = wasEditable;
                                    
                                    if (replaced) {
                                        // 强制刷新DOM并触发input事件
                                        setTimeout(() => {
                                            const event = new Event('input', { bubbles: true });
                                            documentContent.dispatchEvent(event);
                                        }, 50);
                                        
                                        // 切换采纳状态
                                        const newAdoptedState = !isAdopted;
                                        this.setAttribute('data-adopted', newAdoptedState);
                                        
                                        // 更新按钮文本和样式
                                        if (newAdoptedState) {
                                            this.textContent = '回退';
                                            this.classList.remove('bg-green-50', 'text-green-700', 'border-green-200', 'hover:bg-green-100');
                                            this.classList.add('bg-amber-50', 'text-amber-700', 'border-amber-200', 'hover:bg-amber-100');
                                        } else {
                                            this.textContent = '采纳';
                                            this.classList.remove('bg-amber-50', 'text-amber-700', 'border-amber-200', 'hover:bg-amber-100');
                                            this.classList.add('bg-green-50', 'text-green-700', 'border-green-200', 'hover:bg-green-100');
                                        }
                                        
                                        // 显示成功提示
                                        showNotification(isAdopted ? '已回退到原始文本' : '已采纳建议并更新文档内容', 'success');
                                        
                                        // 更新错误卡片样式
                                        const errorCard = this.closest('.bg-white');
                                        if (errorCard) {
                                            if (newAdoptedState) {
                                                errorCard.classList.add('bg-gray-50', 'opacity-70');
                                            } else {
                                                errorCard.classList.remove('bg-gray-50', 'opacity-70');
                                            }
                                        }
                                    } else {
                                        console.warn('未能找到匹配的文本进行替换:', sourceText);
                                        addDebugLog('⚠️ 未能找到匹配的文本进行替换:', sourceText);
                                        showNotification('未找到匹配的文本进行替换', 'warning');
                                    }
                                } catch (err) {
                                    console.error('操作失败:', err);
                                    addDebugLog('❌ 操作失败:', err.message);
                                    showNotification('操作时出错，请重试', 'error');
                                }
                            }
                        });
                    });
                }
                
                // 显示通知消息
                function showNotification(message, type = 'info') {
                    // 检查是否已存在通知元素
                    let notificationContainer = document.getElementById('notification-container');
                    if (!notificationContainer) {
                        notificationContainer = document.createElement('div');
                        notificationContainer.id = 'notification-container';
                        notificationContainer.className = 'fixed top-4 right-4 z-50 flex flex-col space-y-2';
                        document.body.appendChild(notificationContainer);
                    }
                    
                    // 创建通知元素
                    const notification = document.createElement('div');
                    
                    // 设置样式和内容
                    let bgColor, icon;
                    if (type === 'success') {
                        bgColor = 'bg-green-500';
                        icon = 'fa-check-circle';
                    } else if (type === 'error') {
                        bgColor = 'bg-red-500';
                        icon = 'fa-times-circle';
                    } else {
                        bgColor = 'bg-primary';
                        icon = 'fa-info-circle';
                    }
                    
                    notification.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg flex items-center transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
                    notification.innerHTML = `
                        <i class="fa ${icon} mr-2"></i>
                        <span>${message}</span>
                    `;
                    
                    // 添加到容器
                    notificationContainer.appendChild(notification);
                    
                    // 显示通知
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full', 'opacity-0');
                    }, 10);
                    
                    // 3秒后隐藏通知
                    setTimeout(() => {
                        notification.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }, 3000);
                }
                
                // 仅在开发模式下添加调试功能
                if (window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1')) {
                    // 添加测试按钮和功能
                    function addTestFunctionality() {
                        // 检查是否已存在测试按钮
                        if (document.getElementById('test-highlight-btn')) {
                            return;
                        }
                        
                        // 创建测试按钮容器
                        const testContainer = document.createElement('div');
                        testContainer.className = 'fixed bottom-4 right-4 z-50';
                        
                        // 创建测试按钮
                        const testBtn = document.createElement('button');
                        testBtn.id = 'test-highlight-btn';
                        testBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors';
                        testBtn.textContent = '测试文本高亮';
                        
                        // 添加点击事件
                        testBtn.addEventListener('click', function() {
                            // 显示调试区域
                            const debugArea = document.getElementById('debug-log-area');
                            if (debugArea) {
                                debugArea.style.display = 'block';
                                debugArea.scrollTop = debugArea.scrollHeight;
                            }
                            
                            // 获取文档中的一些文本作为测试
                            const documentContent = document.getElementById('document-content');
                            if (documentContent) {
                                const sampleText = documentContent.textContent.substring(0, 20);
                                addDebugLog('===== 开始测试文本高亮 =====');
                                highlightTextInDocument(sampleText, sampleText);
                                addDebugLog('===== 测试文本高亮完成 =====');
                            } else {
                                addDebugLog('❌ 错误: 未找到document-content元素，无法进行测试');
                            }
                        });
                        
                        // 添加到页面
                        testContainer.appendChild(testBtn);
                        document.body.appendChild(testContainer);
                    }
                    
                    // 创建一个简单的调试日志显示区域
                    function createDebugLogArea() {
                        // 检查是否已存在
                        if (document.getElementById('debug-log-area')) return;
                        
                        const logArea = document.createElement('div');
                        logArea.id = 'debug-log-area';
                        logArea.style.cssText = `
                            position: fixed;
                            bottom: 60px;
                            right: 20px;
                            width: 400px;
                            height: 200px;
                            background: rgba(0, 0, 0, 0.8);
                            color: white;
                            padding: 10px;
                            border-radius: 8px;
                            font-family: monospace;
                            font-size: 12px;
                            overflow-y: auto;
                            z-index: 1000;
                            display: none;
                        `;
                        
                        const toggleBtn = document.createElement('button');
                        toggleBtn.innerText = '显示调试日志';
                        toggleBtn.style.cssText = `
                            position: fixed;
                            bottom: 20px;
                            right: 120px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            z-index: 1001;
                        `;
                        
                        toggleBtn.addEventListener('click', function() {
                            if (logArea.style.display === 'none') {
                                logArea.style.display = 'block';
                                toggleBtn.innerText = '隐藏调试日志';
                            } else {
                                logArea.style.display = 'none';
                                toggleBtn.innerText = '显示调试日志';
                            }
                        });
                        
                        document.body.appendChild(toggleBtn);
                        document.body.appendChild(logArea);
                    }
                    
                    // 在调试日志区域添加消息
                    function addDebugLog(message) {
                        const logArea = document.getElementById('debug-log-area');
                        if (logArea) {
                            const logEntry = document.createElement('div');
                            logEntry.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
                            logArea.appendChild(logEntry);
                            logArea.scrollTop = logArea.scrollHeight;
                        }
                    }
                    
                    // 调用调试功能
                    createDebugLogArea();
                    
                    // 仅在首次加载时显示调试提示
                    if (!localStorage.getItem('debugInstructionShown')) {
                        setTimeout(() => {
                            showNotification('开发模式：可按F12打开控制台查看调试信息', 'info');
                            localStorage.setItem('debugInstructionShown', 'true');
                        }, 1000);
                    }
                }
                
                // 修改setupErrorCardInteractions函数，添加调试日志
                const originalSetupErrorCardInteractions = setupErrorCardInteractions;
                setupErrorCardInteractions = function() {
                    addDebugLog('初始化错误卡片交互...');
                    originalSetupErrorCardInteractions();
                    addDebugLog('错误卡片交互初始化完成');
                };
                
                // 初始化
                createDebugLogArea();
                setupErrorCardInteractions();
                
                // 显示调试提示
                if (window.location.href.includes('localhost') || window.location.href.includes('127.0.0.1')) {
                    // 仅在开发模式下显示调试说明
                    function showDebugInstruction() {
                        showNotification('开发模式：可按F12打开控制台查看调试信息', 'info');
                    }
                    showDebugInstruction();
                }
            
            // 在文档内容中高亮显示指定文本
            function highlightTextInDocument(originalText, contextText) {
                // 添加调试信息
                console.log('尝试高亮文本:', originalText);
                console.log('上下文文本:', contextText);
                
                // 直接在函数内部获取documentContent元素，避免作用域问题
                const documentContent = document.getElementById('document-content');
                if (!documentContent) {
                    console.error('未找到document-content元素！');
                    return;
                }
                
                const documentText = documentContent.textContent;
                
                // 记录文档内容长度，检查是否存在内容
                console.log('文档内容长度:', documentText.length);
                
                // 首先尝试直接查找原始文本
                let textToHighlight = originalText;
                let index = documentText.indexOf(textToHighlight);
                
                console.log('直接查找结果索引:', index);
                
                // 如果找不到，尝试在上下文中查找
                if (index === -1 && contextText) {
                    textToHighlight = contextText;
                    index = documentText.indexOf(textToHighlight);
                    console.log('上下文查找结果索引:', index);
                }
                
                // 移除之前的高亮
                console.log('移除之前的高亮元素');
                document.querySelectorAll('.highlighted-text').forEach(el => {
                    const parent = el.parentNode;
                    if (parent) {
                        parent.replaceChild(document.createTextNode(el.textContent), el);
                    }
                });
                
                // 尝试查找并高亮文本
                let found = false;
                
                // 获取所有文本节点
                const textNodes = [];
                function collectTextNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        textNodes.push(node);
                    } else {
                        for (let i = 0; i < node.childNodes.length; i++) {
                            collectTextNodes(node.childNodes[i]);
                        }
                    }
                }
                collectTextNodes(documentContent);
                
                console.log('总共找到文本节点数量:', textNodes.length);
                
                // 尝试在每个文本节点中查找匹配
                for (let i = 0; i < textNodes.length; i++) {
                    const textNode = textNodes[i];
                    const textNodeIndex = textNode.textContent.indexOf(textToHighlight);
                    
                    if (textNodeIndex !== -1) {
                        console.log('在文本节点中找到匹配:', i, textNode.textContent.substring(textNodeIndex, textNodeIndex + 20) + '...');
                        
                        try {
                            // 创建Range对象
                            const range = document.createRange();
                            const selection = window.getSelection();
                            
                            // 设置Range范围
                            range.setStart(textNode, textNodeIndex);
                            range.setEnd(textNode, textNodeIndex + textToHighlight.length);
                            
                            // 清除当前选择
                            selection.removeAllRanges();
                            
                            // 添加新的Range到选择
                            selection.addRange(range);
                            
                            // 滚动到选中的文本
                            console.log('滚动到选中的文本');
                            range.startContainer.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // 高亮显示
                            console.log('执行高亮显示');
                            highlightRange(range);
                            
                            found = true;
                            break;
                        } catch (e) {
                            console.error('高亮过程中出现错误:', e);
                        }
                    }
                }
                
                if (!found) {
                    console.warn('未找到匹配的文本:', textToHighlight);
                    // 尝试使用简化的方法，直接选择第一个文本节点的部分内容作为演示
                    if (textNodes.length > 0) {
                        console.log('使用演示高亮');
                        const range = document.createRange();
                        const selection = window.getSelection();
                        const demoNode = textNodes[0];
                        const demoLength = Math.min(10, demoNode.textContent.length);
                        
                        range.setStart(demoNode, 0);
                        range.setEnd(demoNode, demoLength);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        highlightRange(range);
                        demoNode.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                console.log('高亮操作完成');
            }
            
            // 查找包含指定文本的文本节点
            function findTextNodeContaining(element, text) {
                if (element.nodeType === Node.TEXT_NODE && element.textContent.includes(text)) {
                    return element;
                }
                
                for (let i = 0; i < element.childNodes.length; i++) {
                    const found = findTextNodeContaining(element.childNodes[i], text);
                    if (found) {
                        return found;
                    }
                }
                
                return null;
            }
            
            // 高亮显示指定的Range
                function highlightRange(range) {
                    // 创建高亮元素
                    const highlight = document.createElement('span');
                    highlight.className = 'highlighted-text bg-yellow-200';
                    
                    try {
                        // 环绕Range内容
                        range.surroundContents(highlight);
                    } catch (e) {
                        // 如果内容跨多个元素，使用另一种方式
                        const fragment = range.extractContents();
                        highlight.appendChild(fragment);
                        range.insertNode(highlight);
                    }
                }
        
            // 不再需要模拟函数，直接使用实际的API调用
            
            // 文件上传处理函数
            async function handleFileSelection(file) {
                // 显示文件信息
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                
                try {
                    // 创建FormData对象，用于文件上传
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // 显示加载状态
                    documentContent.innerHTML = `<div class="flex items-center justify-center h-40 text-gray-500"><i class="fa fa-spinner fa-spin mr-2"></i>正在解析文件内容...</div>`;
                    documentContent.style.background = '#fafafa';
                    documentContent.style.padding = '20px';
                    documentContent.style.borderRadius = '8px';
                    
                    // 清空错误结果区域
                    const errorResultsContainer = document.getElementById('error-results');
                    errorResultsContainer.innerHTML = `<div class="text-center text-gray-500 py-8">
                        <i class="fa fa-spinner fa-spin text-4xl mb-2"></i>
                        <p>正在检测文档错误...</p>
                    </div>`;
                    
                    // 获取后端API地址
                    let apiUrl = 'http://localhost:3000/api/upload'; // 默认地址
                    if (window.toolConfig && window.toolConfig['文稿卫士'] && window.toolConfig['文稿卫士'].serviceUrl) {
                        apiUrl = window.toolConfig['文稿卫士'].serviceUrl + '/upload';
                    }
                    
                    // 调用后端API上传并解析文件
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('服务器响应错误');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('从后端接收到的数据格式:', data.format);
                        console.log('从后端接收到的原始内容:', data.content);
                        
                        // 填充可编辑区域，展示后端返回的内容，根据格式类型选择不同的处理方式
                        displayFileContent(data.content, data.format);
                        
                        // 显示文档错误检测结果
                        displayDocumentErrors(data.errors);
                    } else {
                        throw new Error(data.error || '解析文件失败');
                    }
                } catch (error) {
                    console.error('获取文件内容失败:', error);
                    documentContent.innerHTML = `<p class="text-red-500">获取文件内容失败：${error.message}</p>`;
                    
                    // 显示错误信息
                    const errorResultsContainer = document.getElementById('error-results');
                    errorResultsContainer.innerHTML = `<div class="text-center text-red-500 py-8">
                        <i class="fa fa-exclamation-circle text-4xl mb-2"></i>
                        <p>文件处理失败，请重试</p>
                    </div>`;
                }
            }
            
            // 显示文件内容，根据格式类型选择不同的处理方式
            function displayFileContent(content, format) {
                let formattedContent;
                
                if (format === 'html') {
                    // HTML格式内容（主要来自Word文档）需要处理并正确渲染
                    // 移除mammoth生成的不必要的锚点标签
                    formattedContent = content.replace(/<a\s+id="[^"]+"><\/a>/g, '');
                    
                    // 检查是否存在转义的HTML字符，并进行反转义
                    if (formattedContent.includes('&lt;') || formattedContent.includes('&gt;')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = formattedContent;
                        formattedContent = tempDiv.innerHTML;
                    }
                } else if (format === 'plaintext' || format === 'pdf') {
                    // 纯文本内容（来自TXT文件）和PDF文件需要处理换行符和特殊字符
                    // 转义HTML特殊字符
                    const escapedContent = escapeHtml(content);
                    
                    // 处理换行符为<br>标签
                    // 处理多个换行符，尝试保持段落结构
                    formattedContent = escapedContent
                        .replace(/\r\n/g, '\n')  // 统一换行符格式
                        .replace(/\n\n+/g, '</p><p>')  // 将多个换行符转换为段落
                        .replace(/\n/g, '<br>');  // 将单个换行符转换为<br>
                    
                    // 添加段落标签
                    if (!formattedContent.startsWith('<p>')) {
                        formattedContent = '<p>' + formattedContent;
                    }
                    if (!formattedContent.endsWith('</p>')) {
                        formattedContent = formattedContent + '</p>';
                    }
                    
                    // 处理项目符号和编号列表（简单实现）
                    formattedContent = formattedContent
                        .replace(/<p>•\s+/g, '<p class="list-disc pl-5">')
                        .replace(/<p>\d+\.\s+/g, '<p class="list-decimal pl-5">');
                }
                
                // 根据用户要求，Word文档(html格式)也需要可编辑
                documentContent.contentEditable = true;
                documentContent.style.cursor = 'text';
                documentContent.style.userSelect = 'auto';
                documentContent.style.webkitUserSelect = 'auto';
                documentContent.style.mozUserSelect = 'auto';
                documentContent.style.msUserSelect = 'auto';
                
                // 递归设置所有子元素为可编辑
                const setAllChildrenEditable = (element) => {
                    element.contentEditable = true;
                    for (let i = 0; i < element.children.length; i++) {
                        setAllChildrenEditable(element.children[i]);
                    }
                };
                setAllChildrenEditable(documentContent);
                
                // 清空容器并设置内容
                documentContent.innerHTML = '';
                
                // 创建一个临时元素来解析HTML内容
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = formattedContent;
                
                // 将解析后的节点添加到documentContent
                while (tempDiv.firstChild) {
                    documentContent.appendChild(tempDiv.firstChild);
                }
            }
            
            // 显示文档错误检测结果
                    function displayDocumentErrors(errors) {
                        const errorResultsContainer = document.getElementById('error-results');
                        const errorCountElement = document.getElementById('error-count');
                        const allErrorsBtn = document.getElementById('all-errors-btn');
                        const typoErrorsBtn = document.getElementById('typo-errors-btn');
                        const grammarErrorsBtn = document.getElementById('grammar-errors-btn');

                        const suggestionBtn = document.getElementById('suggestion-btn');
                        
                        // 更新错误计数
                        const errorCount = errors && errors.length > 0 ? errors.length : 0;
                        errorCountElement.textContent = errorCount;
                        
                        // 更新全部错误按钮的计数
                        if (allErrorsBtn) {
                            allErrorsBtn.textContent = `全部错误 (${errorCount})`;
                        }
                        
                        // 计算各类错误数量
                        const typoCount = errors ? errors.filter(e => e.type === '错别字').length : 0;
                        const grammarCount = errors ? errors.filter(e => e.type === '语法错误').length : 0;
                        const suggestionCount = errors ? errors.filter(e => e.type === '优化建议').length : 0;
                        
                        // 更新各类错误按钮的计数
                        if (typoErrorsBtn) {
                            typoErrorsBtn.textContent = `错别字 (${typoCount})`;
                        }
                        if (grammarErrorsBtn) {
                            grammarErrorsBtn.textContent = `语法错误 (${grammarCount})`;
                        }
                        if (suggestionBtn) {
                            suggestionBtn.textContent = `优化建议 (${suggestionCount})`;
                        }
                        
                        // 如果没有错误，显示成功信息
                        if (!errors || errors.length === 0) {
                            errorResultsContainer.innerHTML = `<div class="text-center text-green-500 py-8">
                                <i class="fa fa-check-circle text-4xl mb-2"></i>
                                <p>文档检测完成，未发现错误</p>
                            </div>`;
                            return;
                        }
                        
                        // 清空容器
                        errorResultsContainer.innerHTML = '';
                        
                        // 按错误类型分组
                        const errorsByType = {};
                        errors.forEach(error => {
                            if (!errorsByType[error.type]) {
                                errorsByType[error.type] = [];
                            }
                            errorsByType[error.type].push(error);
                        });
                        
                        // 生成每个错误类型的区域
                        Object.entries(errorsByType).forEach(([errorType, typeErrors]) => {
                            // 设置错误类型的样式
                            let iconClass = 'fa-exclamation-circle';
                            let headerColor = 'bg-yellow-50';
                            let borderColor = 'border-yellow-500';
                            let textColor = 'text-yellow-500';
                            
                            if (errorType === '错别字' || errorType === '语法错误') {
                                iconClass = 'fa-times-circle';
                                headerColor = 'bg-red-50';
                                borderColor = 'border-red-500';
                                textColor = 'text-red-500';
                            } else if (errorType === '优化建议') {
                                iconClass = 'fa-lightbulb';
                                headerColor = 'bg-blue-50';
                                borderColor = 'border-blue-500';
                                textColor = 'text-blue-500';
                            }
                            
                            // 创建错误类型标题区域
                            const typeHeader = document.createElement('div');
                            typeHeader.className = `mt-4 ${headerColor} border-l-4 ${borderColor} p-2 rounded-t-lg`;
                            typeHeader.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="${textColor} mr-2"><i class="fa ${iconClass}"></i></span>
                                        <span class="font-medium text-gray-800 text-base">${errorType}（${typeErrors.length}个）</span>
                                    </div>
                                </div>
                            `;
                            errorResultsContainer.appendChild(typeHeader);
                            
                            // 创建错误类型内容区域
                            const typeContainer = document.createElement('div');
                            typeContainer.className = 'border border-t-0 border-gray-200 rounded-b-lg overflow-hidden';
                            errorResultsContainer.appendChild(typeContainer);
                            
                            // 为该类型的每个错误生成卡片
                            typeErrors.forEach((error, index) => {                        
                                const errorCard = document.createElement('div');
                                errorCard.className = 'bg-white p-1 border-b border-gray-200 last:border-b-0 hover:shadow-sm transition-shadow';
                                
                                // 生成错误内容卡片 - 只显示错误的词语或句子
                                // 先确保原始和纠正文本存在且类型正确
                                const originalText = error.original || '';
                                const correctedText = error.corrected || '';
                                
                                // 转义HTML特殊字符
                                const safeOriginal = escapeHtml(originalText);
                                const safeCorrected = escapeHtml(correctedText);
                                const safeContext = escapeHtml(error.context || '');
                                
                                // 生成错误内容卡片HTML - 更紧凑版
                                const errorCardHtml = `
                                    <div class="flex flex-col md:flex-row items-center gap-0.5 p-0.5 border-b border-gray-100 last:border-b-0 overflow-x-auto hover:bg-gray-50 transition-colors max-w-full">
                                        <!-- 序号区域 -->
                                        <div class="w-6 h-6 flex-shrink-0 flex items-center justify-center bg-blue-50 text-blue-600 rounded-full text-xs font-semibold">
                                            ${index + 1}
                                        </div>
                                        
                                        <!-- 主要内容区域 - 包含按钮和文本在同一行 -->
                                        <div class="flex-grow">
                                            <!-- 文本和按钮在同一行 -->
                                            <div class="flex items-center flex-wrap gap-0.5 min-w-max">
                                                <!-- 错误内容 -->
                                                <p class="text-gray-800 bg-gray-50 p-1 rounded border border-gray-200 error-content-card cursor-pointer hover:bg-gray-100 transition-all duration-200 whitespace-nowrap flex items-center h-7">
                                                    <span class="bg-red-100 text-red-700 px-1 py-0.5 rounded text-xs">${safeOriginal}</span>
                                                </p>
                                                
                                                <!-- 修改箭头 -->
                                                <div class="text-gray-500 font-medium text-xs">
                                                    →
                                                </div>
                                                
                                                <!-- 建议修改 -->
                                                <p class="text-gray-800 ${error.type === '优化建议' ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200'} p-1 rounded border whitespace-nowrap flex items-center h-7 mr-2">
                                                    <span class="bg-green-100 text-green-700 px-1 py-0.5 rounded text-xs">${safeCorrected}</span>
                                                </p>
                                                
                                                <!-- 采纳按钮 -->
                                                <button class="px-2 py-0.5 text-xs text-green-700 bg-green-50 border border-green-200 rounded-md hover:bg-green-100 hover:shadow-md transition-all duration-200 adopt-suggestion-btn whitespace-nowrap flex items-center justify-center h-7" data-original="${safeOriginal}" data-corrected="${safeCorrected}">
                                                    采纳
                                                </button>
                                                 
                                            </div>
                                        </div>
                                    </div>`;
                                
                                // 设置错误卡片HTML内容
                                errorCard.innerHTML = errorCardHtml;
                                
                                // 将错误卡片添加到类型容器中
                                typeContainer.appendChild(errorCard);
                            });
                        });
                        
                        // 确保结果区域显示
                        errorResultsContainer.style.display = 'block';
                        
                        // 设置错误卡片交互事件
                        setupErrorCardInteractions();
                        
                        // 绑定采纳建议按钮事件
                        setupAdoptButtons();
                        setupErrorCardInteractions();
                    }
                
                // 应用样式，使显示更接近WPS文档编辑器 - 紧凑版
                documentContent.style.background = '#ffffff';
                documentContent.style.padding = '16px';
                documentContent.style.borderRadius = '4px';
                documentContent.style.boxShadow = 'inset 0 0 0 1px #e0e0e0';
                documentContent.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
                documentContent.style.lineHeight = '1.6';
                documentContent.style.color = '#333';
                documentContent.style.letterSpacing = '0.01em';
                documentContent.style.fontSize = '14px';
                
                // 自动调整高度以适应内容
                documentContent.style.minHeight = 'calc(100vh - 150px)';
                
                // 添加一些全局样式以确保表格和其他元素正确显示
                const style = document.createElement('style');
                style.textContent = `
                    #document-content table {
                        border-collapse: collapse;
                        width: 100%;
                        margin: 16px 0;
                    }
                    #document-content th,
                    #document-content td {
                        border: 1px solid #ddd;
                        padding: 8px 12px;
                    }
                    #document-content th {
                        background-color: #f2f2f2;
                        font-weight: 600;
                    }
                    #document-content tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }
                    #document-content h1, #document-content h2, #document-content h3, #document-content h4, #document-content h5, #document-content h6 {
                        margin-top: 24px;
                        margin-bottom: 16px;
                        font-weight: 600;
                        line-height: 1.25;
                    }
                    #document-content h1 { font-size: 2em; }
                    #document-content h2 { font-size: 1.5em; }
                    #document-content h3 { font-size: 1.25em; }
                    #document-content p {
                        margin-top: 0;
                        margin-bottom: 16px;
                    }
                `;
                document.head.appendChild(style);
            
            // 清空内容按钮事件处理
            clearContentBtn.addEventListener('click', function() {
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                documentContent.innerHTML = `<p class="text-gray-400">在此处输入或粘贴文本内容，或点击上方上传按钮导入文件...</p>`;
                documentContent.style.background = 'white';
                documentContent.style.padding = '24px';
                documentContent.style.borderRadius = '0';
                
                // 清空错误详情区域
                const errorResultsContainer = document.getElementById('error-results');
                const errorCountElement = document.getElementById('error-count');
                const allErrorsBtn = document.getElementById('all-errors-btn');
                const typoErrorsBtn = document.getElementById('typo-errors-btn');
                const grammarErrorsBtn = document.getElementById('grammar-errors-btn');
                const suggestionBtn = document.getElementById('suggestion-btn');
                
                // 清空错误结果
                errorResultsContainer.innerHTML = '';
                
                // 重置错误计数
                errorCountElement.textContent = '0';
                
                // 重置按钮计数
                if (allErrorsBtn) {
                    allErrorsBtn.textContent = '全部错误 (0)';
                }
                if (typoErrorsBtn) {
                    typoErrorsBtn.textContent = '错别字 (0)';
                }
                if (grammarErrorsBtn) {
                    grammarErrorsBtn.textContent = '语法错误 (0)';
                }
                if (suggestionBtn) {
                    suggestionBtn.textContent = '优化建议 (0)';
                }
            });
        
        }); // 闭合DOMContentLoaded事件监听器
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 转义HTML特殊字符
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 为所有按钮添加悬停效果
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'translateY(-1px)';
                button.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                button.style.transition = 'all 0.2s ease';
            });
            
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'translateY(0)';
                button.style.boxShadow = 'none';
            });
        });
    </script>
</body>
</html>